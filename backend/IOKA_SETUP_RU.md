# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Ioka API - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

## –≠—Ç–∞–ø A: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Flask Backend ‚úì

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `.env.example` —Å –∫–ª—é—á–∞–º–∏:
```env
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Ioka Payment Gateway
IOKA_API_KEY=test_***
IOKA_BASE_URL=https://stage-api.ioka.kz
IOKA_WEBHOOK_SECRET=your_webhook_secret_here

# URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
FRONTEND_URL=http://localhost:3000
BACKEND_URL=http://localhost:5000
```

#### –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `.env.example`:
```bash
cd backend
cp .env.example .env
```

–ó–∞—Ç–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- `IOKA_API_KEY` - –ø–æ–ª—É—á–∏—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Ioka
- `IOKA_WEBHOOK_SECRET` - —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–û–±–Ω–æ–≤–ª–µ–Ω `requirements.txt`:
```txt
Flask==2.3.3
Flask-SQLAlchemy==3.0.5
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
PyJWT==2.8.0
gunicorn==21.2.0
psycopg2-binary==2.9.7
Flask-Limiter==3.5.0
requests==2.31.0        # ‚Üê –ù–æ–≤–æ–µ
python-dotenv==1.0.0    # ‚Üê –ù–æ–≤–æ–µ
```

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
cd backend
pip install -r requirements.txt
```

### 3. –°–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Ioka

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `ioka_service.py` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏:

#### `create_payment_order()`
–°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∑–∞–∫–∞–∑ –≤ Ioka.
```python
payment_result = ioka_service.create_payment_order(
    amount=5000,  # –°—É–º–º–∞ –≤ —Ç–µ–Ω–≥–µ
    description="–ü–æ—Å–∞–¥–∫–∞ 10 –¥–µ—Ä–µ–≤—å–µ–≤",
    donation_id="donation_uuid",
    customer_email="user@example.com",
    customer_name="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
)
```

#### `get_payment_status()`
–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ Ioka.

#### `verify_webhook_signature()`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –≤–µ–±—Ö—É–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

#### `refund_payment()`
–ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤.

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –≤ –º–æ–¥–µ–ª—å `Donation`:
```python
class Donation(db.Model):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    payment_order_id = db.Column(db.String)  # ID –∑–∞–∫–∞–∑–∞ –≤ Ioka
```

–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```bash
cd backend
flask db upgrade
```

### 5. API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
POST /api/donations/{donation_id}/payment
Authorization: Bearer {token}
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "checkout_url": "https://checkout.ioka.kz/...",
  "order_id": "ord_xxxxx",
  "donation_id": "donation_uuid",
  "status": "awaiting_payment"
}
```

#### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –≥–æ—Å—Ç—è
```
POST /api/guest-donations/{donation_id}/payment
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Ioka
```
POST /api/webhooks/ioka
X-Ioka-Signature: {signature}
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è:
- `payment.succeeded` - –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
- `payment.failed` - –ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª
- `payment.cancelled` - –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω

## –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –¥–æ–Ω–∞—Ç
   ‚Üì status: pending

2. –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–ª–∞—Ç–µ–∂
   ‚Üì –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–∫–∞–∑ –≤ Ioka
   ‚Üì status: awaiting_payment

3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ Ioka Checkout
   ‚Üì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã

4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
   ‚Üì Ioka –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–±—Ö—É–∫

5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
   ‚Üì status: completed
   ‚Üì –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

6. –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
cd backend
python test_ioka.py
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã (–¥–ª—è stage.ioka.kz)
- **–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂:** 4242 4242 4242 4242
- **–ù–µ—É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂:** 4000 0000 0000 0002
- **CVV:** –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã
- **–°—Ä–æ–∫:** –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ–±—Ö—É–∫–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
ngrok http 5000
```

–ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ `BACKEND_URL` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Ioka –Ω–∞ URL –æ—Ç ngrok.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–∞
–í—Å–µ –≤–µ–±—Ö—É–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é HMAC-SHA256:
```python
expected_signature = hmac.new(
    webhook_secret.encode('utf-8'),
    payload,
    hashlib.sha256
).hexdigest()
```

### –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚ùå –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` —Ñ–∞–π–ª
- ‚úì –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω
- ‚úì –•—Ä–∞–Ω–∏—Ç–µ API –∫–ª—é—á–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã

### –≠—Ç–∞–ø B: Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
1. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ Ioka Checkout
2. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å return URL –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
3. –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞

### –≠—Ç–∞–ø C: –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
1. –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–¥–∞–∫—à–Ω API –∫–ª—é—á–∏ –æ—Ç Ioka
2. –û–±–Ω–æ–≤–∏—Ç—å `IOKA_BASE_URL` –Ω–∞ `https://api.ioka.kz`
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL –≤ –ø–∞–Ω–µ–ª–∏ Ioka
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

### –≠—Ç–∞–ø D: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
2. –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
```
backend/
‚îú‚îÄ‚îÄ .env.example                          # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ requirements.txt                      # –û–±–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ ioka_service.py                       # –°–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Ioka
‚îú‚îÄ‚îÄ app.py                                # –û–±–Ω–æ–≤–ª–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
‚îú‚îÄ‚îÄ test_ioka.py                         # –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ‚îÄ IOKA_INTEGRATION.md                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (EN)
‚îú‚îÄ‚îÄ IOKA_SETUP_RU.md                     # –≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
‚îî‚îÄ‚îÄ migrations/versions/
    ‚îî‚îÄ‚îÄ add_payment_order_id.py          # –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Ioka:** https://ioka.kz/docs
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Ioka:** support@ioka.kz
- **–°—Ç–∞—Ç—É—Å API:** https://status.ioka.kz

## –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏

–ï—Å–ª–∏ Ioka –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (`IOKA_ENABLED=False`), —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ä–µ–∂–∏–º–µ fallback - –¥–æ–Ω–∞—Ç—ã –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Ioka.

## –ì–æ—Ç–æ–≤–æ! üéâ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Ioka API (–≠—Ç–∞–ø A) –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –±—ç–∫–µ–Ω–¥ –≥–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Ioka.
